<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>IPython.utils.traitlets &mdash; OpenAlea community website</title>
    
    <link rel="stylesheet" href="../../../_static/virtualplants.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="top" title="OpenAlea community website" href="../../../index.html" />
    <link rel="up" title="Module code" href="../../index.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">OpenAlea community website</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for IPython.utils.traitlets</h1><div class="highlight"><pre>
<span class="c"># encoding: utf-8</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">A lightweight Traits like module.</span>

<span class="sd">This is designed to provide a lightweight, simple, pure Python version of</span>
<span class="sd">many of the capabilities of enthought.traits.  This includes:</span>

<span class="sd">* Validation</span>
<span class="sd">* Type specification with defaults</span>
<span class="sd">* Static and dynamic notification</span>
<span class="sd">* Basic predefined types</span>
<span class="sd">* An API that is similar to enthought.traits</span>

<span class="sd">We don&#39;t support:</span>

<span class="sd">* Delegation</span>
<span class="sd">* Automatic GUI generation</span>
<span class="sd">* A full set of trait types.  Most importantly, we don&#39;t provide container</span>
<span class="sd">  traits (list, dict, tuple) that can trigger notifications if their</span>
<span class="sd">  contents change.</span>
<span class="sd">* API compatibility with enthought.traits</span>

<span class="sd">There are also some important difference in our design:</span>

<span class="sd">* enthought.traits does not validate default values.  We do.</span>

<span class="sd">We choose to create this module because we need these capabilities, but</span>
<span class="sd">we need them to be pure Python so they work in all Python implementations,</span>
<span class="sd">including Jython and IronPython.</span>

<span class="sd">Inheritance diagram:</span>

<span class="sd">.. inheritance-diagram:: IPython.utils.traitlets</span>
<span class="sd">   :parts: 3</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="c"># Copyright (c) IPython Development Team.</span>
<span class="c"># Distributed under the terms of the Modified BSD License.</span>
<span class="c">#</span>
<span class="c"># Adapted from enthought.traits, Copyright (c) Enthought, Inc.,</span>
<span class="c"># also under the terms of the Modified BSD License.</span>

<span class="kn">import</span> <span class="nn">contextlib</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">types</span>
<span class="kn">from</span> <span class="nn">types</span> <span class="kn">import</span> <span class="n">FunctionType</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">types</span> <span class="kn">import</span> <span class="n">ClassType</span><span class="p">,</span> <span class="n">InstanceType</span>
    <span class="n">ClassTypes</span> <span class="o">=</span> <span class="p">(</span><span class="n">ClassType</span><span class="p">,</span> <span class="nb">type</span><span class="p">)</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">ClassTypes</span> <span class="o">=</span> <span class="p">(</span><span class="nb">type</span><span class="p">,)</span>

<span class="kn">from</span> <span class="nn">.importstring</span> <span class="kn">import</span> <span class="n">import_item</span>
<span class="kn">from</span> <span class="nn">IPython.utils</span> <span class="kn">import</span> <span class="n">py3compat</span>
<span class="kn">from</span> <span class="nn">IPython.utils.py3compat</span> <span class="kn">import</span> <span class="n">iteritems</span>
<span class="kn">from</span> <span class="nn">IPython.testing.skipdoctest</span> <span class="kn">import</span> <span class="n">skip_doctest</span>

<span class="n">SequenceTypes</span> <span class="o">=</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,</span> <span class="nb">set</span><span class="p">,</span> <span class="nb">frozenset</span><span class="p">)</span>

<span class="c">#-----------------------------------------------------------------------------</span>
<span class="c"># Basic classes</span>
<span class="c">#-----------------------------------------------------------------------------</span>


<span class="k">class</span> <span class="nc">NoDefaultSpecified</span> <span class="p">(</span> <span class="nb">object</span> <span class="p">):</span> <span class="k">pass</span>
<span class="n">NoDefaultSpecified</span> <span class="o">=</span> <span class="n">NoDefaultSpecified</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">Undefined</span> <span class="p">(</span> <span class="nb">object</span> <span class="p">):</span> <span class="k">pass</span>
<span class="n">Undefined</span> <span class="o">=</span> <span class="n">Undefined</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">TraitError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="c">#-----------------------------------------------------------------------------</span>
<span class="c"># Utilities</span>
<span class="c">#-----------------------------------------------------------------------------</span>


<span class="k">def</span> <span class="nf">class_of</span> <span class="p">(</span> <span class="nb">object</span> <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Returns a string containing the class name of an object with the</span>
<span class="sd">    correct indefinite article (&#39;a&#39; or &#39;an&#39;) preceding it (e.g., &#39;an Image&#39;,</span>
<span class="sd">    &#39;a PlotValue&#39;).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span> <span class="nb">object</span><span class="p">,</span> <span class="n">py3compat</span><span class="o">.</span><span class="n">string_types</span> <span class="p">):</span>
        <span class="k">return</span> <span class="n">add_article</span><span class="p">(</span> <span class="nb">object</span> <span class="p">)</span>

    <span class="k">return</span> <span class="n">add_article</span><span class="p">(</span> <span class="nb">object</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span> <span class="p">)</span>


<span class="k">def</span> <span class="nf">add_article</span> <span class="p">(</span> <span class="n">name</span> <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Returns a string containing the correct indefinite article (&#39;a&#39; or &#39;an&#39;)</span>
<span class="sd">    prefixed to the specified string.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">name</span><span class="p">[:</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="s">&#39;aeiou&#39;</span><span class="p">:</span>
       <span class="k">return</span> <span class="s">&#39;an &#39;</span> <span class="o">+</span> <span class="n">name</span>

    <span class="k">return</span> <span class="s">&#39;a &#39;</span> <span class="o">+</span> <span class="n">name</span>


<span class="k">def</span> <span class="nf">repr_type</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Return a string representation of a value and its type for readable</span>
<span class="sd">    error messages.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">the_type</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">py3compat</span><span class="o">.</span><span class="n">PY3</span><span class="p">)</span> <span class="ow">and</span> <span class="n">the_type</span> <span class="ow">is</span> <span class="n">InstanceType</span><span class="p">:</span>
        <span class="c"># Old-style class.</span>
        <span class="n">the_type</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">__class__</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%r</span><span class="s"> </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">the_type</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">msg</span>


<span class="k">def</span> <span class="nf">is_trait</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Returns whether the given value is an instance or subclass of TraitType.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">TraitType</span><span class="p">)</span> <span class="ow">or</span>
            <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="nb">type</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">TraitType</span><span class="p">)))</span>


<span class="k">def</span> <span class="nf">parse_notifier_name</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert the name argument to a list of names.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>

<span class="sd">    &gt;&gt;&gt; parse_notifier_name(&#39;a&#39;)</span>
<span class="sd">    [&#39;a&#39;]</span>
<span class="sd">    &gt;&gt;&gt; parse_notifier_name([&#39;a&#39;,&#39;b&#39;])</span>
<span class="sd">    [&#39;a&#39;, &#39;b&#39;]</span>
<span class="sd">    &gt;&gt;&gt; parse_notifier_name(None)</span>
<span class="sd">    [&#39;anytrait&#39;]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">name</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">name</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="s">&#39;anytrait&#39;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span> <span class="s">&quot;names must be strings&quot;</span>
        <span class="k">return</span> <span class="n">name</span>


<span class="k">class</span> <span class="nc">_SimpleTest</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span> <span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">value</span> <span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span>
    <span class="k">def</span> <span class="nf">__call__</span> <span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">test</span>  <span class="p">):</span>
        <span class="k">return</span> <span class="n">test</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span>
    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;&lt;SimpleTest(</span><span class="si">%r</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span>
    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__repr__</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">getmembers</span><span class="p">(</span><span class="nb">object</span><span class="p">,</span> <span class="n">predicate</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A safe version of inspect.getmembers that handles missing attributes.</span>

<span class="sd">    This is useful when there are descriptor based attributes that for</span>
<span class="sd">    some reason raise AttributeError even though they exist.  This happens</span>
<span class="sd">    in zope.inteface with the __provides__ attribute.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="nb">object</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">predicate</span> <span class="ow">or</span> <span class="n">predicate</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
    <span class="n">results</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">results</span>

<span class="nd">@skip_doctest</span>
<span class="k">class</span> <span class="nc">link</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Link traits from different objects together so they remain in sync.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    obj : pairs of objects/attributes</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>

<span class="sd">    &gt;&gt;&gt; c = link((obj1, &#39;value&#39;), (obj2, &#39;value&#39;), (obj3, &#39;value&#39;))</span>
<span class="sd">    &gt;&gt;&gt; obj1.value = 5 # updates other objects as well</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">updating</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&#39;At least two traitlets must be provided.&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">objects</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">initial</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">obj</span><span class="p">,</span><span class="n">attr</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span> <span class="o">!=</span> <span class="n">initial</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">initial</span><span class="p">)</span>

            <span class="n">callback</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_closure</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span><span class="n">attr</span><span class="p">)</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">on_trait_change</span><span class="p">(</span><span class="n">callback</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">objects</span><span class="p">[(</span><span class="n">obj</span><span class="p">,</span><span class="n">attr</span><span class="p">)]</span> <span class="o">=</span> <span class="n">callback</span>

    <span class="nd">@contextlib.contextmanager</span>
    <span class="k">def</span> <span class="nf">_busy_updating</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">updating</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">yield</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">updating</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">_make_closure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sending_obj</span><span class="p">,</span> <span class="n">sending_attr</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update</span><span class="p">(</span><span class="n">sending_obj</span><span class="p">,</span> <span class="n">sending_attr</span><span class="p">,</span> <span class="n">new</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">update</span>

    <span class="k">def</span> <span class="nf">_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sending_obj</span><span class="p">,</span> <span class="n">sending_attr</span><span class="p">,</span> <span class="n">new</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">updating</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_busy_updating</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">obj</span><span class="p">,</span><span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">sending_obj</span> <span class="ow">or</span> <span class="n">attr</span> <span class="o">!=</span> <span class="n">sending_attr</span><span class="p">:</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">new</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">unlink</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">callback</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="p">(</span><span class="n">obj</span><span class="p">,</span><span class="n">attr</span><span class="p">)</span> <span class="o">=</span> <span class="n">key</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">on_trait_change</span><span class="p">(</span><span class="n">callback</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">remove</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="c">#-----------------------------------------------------------------------------</span>
<span class="c"># Base TraitType for all traits</span>
<span class="c">#-----------------------------------------------------------------------------</span>


<span class="k">class</span> <span class="nc">TraitType</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A base class for all trait descriptors.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Our implementation of traits is based on Python&#39;s descriptor</span>
<span class="sd">    prototol.  This class is the base class for all such descriptors.  The</span>
<span class="sd">    only magic we use is a custom metaclass for the main :class:`HasTraits`</span>
<span class="sd">    class that does the following:</span>

<span class="sd">    1. Sets the :attr:`name` attribute of every :class:`TraitType`</span>
<span class="sd">       instance in the class dict to the name of the attribute.</span>
<span class="sd">    2. Sets the :attr:`this_class` attribute of every :class:`TraitType`</span>
<span class="sd">       instance in the class dict to the *class* that declared the trait.</span>
<span class="sd">       This is used by the :class:`This` trait to allow subclasses to</span>
<span class="sd">       accept superclasses for :class:`This` values.</span>
<span class="sd">    &quot;&quot;&quot;</span>


    <span class="n">metadata</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">default_value</span> <span class="o">=</span> <span class="n">Undefined</span>
    <span class="n">info_text</span> <span class="o">=</span> <span class="s">&#39;any value&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">default_value</span><span class="o">=</span><span class="n">NoDefaultSpecified</span><span class="p">,</span> <span class="o">**</span><span class="n">metadata</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a TraitType.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">default_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">NoDefaultSpecified</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="n">default_value</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">metadata</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">metadata</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span> <span class="o">=</span> <span class="n">metadata</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">get_default_value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a new instance of the default value.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_value</span>

    <span class="k">def</span> <span class="nf">instance_init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This is called by :meth:`HasTraits.__new__` to finish init&#39;ing.</span>

<span class="sd">        Some stages of initialization must be delayed until the parent</span>
<span class="sd">        :class:`HasTraits` instance has been created.  This method is</span>
<span class="sd">        called in :meth:`HasTraits.__new__` after the instance has been</span>
<span class="sd">        created.</span>

<span class="sd">        This method trigger the creation and validation of default values</span>
<span class="sd">        and also things like the resolution of str given class names in</span>
<span class="sd">        :class:`Type` and :class`Instance`.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        obj : :class:`HasTraits` instance</span>
<span class="sd">            The parent :class:`HasTraits` instance that has just been</span>
<span class="sd">            created.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_default_value</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">set_default_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the default value on a per instance basis.</span>

<span class="sd">        This method is called by :meth:`instance_init` to create and</span>
<span class="sd">        validate the default value.  The creation and validation of</span>
<span class="sd">        default values must be delayed until the parent :class:`HasTraits`</span>
<span class="sd">        class has been instantiated.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># Check for a deferred initializer defined in the same class as the</span>
        <span class="c"># trait declaration or above.</span>
        <span class="n">mro</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span><span class="o">.</span><span class="n">mro</span><span class="p">()</span>
        <span class="n">meth_name</span> <span class="o">=</span> <span class="s">&#39;_</span><span class="si">%s</span><span class="s">_default&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="k">for</span> <span class="n">cls</span> <span class="ow">in</span> <span class="n">mro</span><span class="p">[:</span><span class="n">mro</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">this_class</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">meth_name</span> <span class="ow">in</span> <span class="n">cls</span><span class="o">.</span><span class="n">__dict__</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># We didn&#39;t find one. Do static initialization.</span>
            <span class="n">dv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_default_value</span><span class="p">()</span>
            <span class="n">newdv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">dv</span><span class="p">)</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">_trait_values</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">newdv</span>
            <span class="k">return</span>
        <span class="c"># Complete the dynamic initialization.</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">_trait_dyn_inits</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">meth_name</span>

    <span class="k">def</span> <span class="nf">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">cls</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the value of the trait by self.name for the instance.</span>

<span class="sd">        Default values are instantiated when :meth:`HasTraits.__new__`</span>
<span class="sd">        is called.  Thus by the time this method gets called either the</span>
<span class="sd">        default value or a user defined value (they called :meth:`__set__`)</span>
<span class="sd">        is in the :class:`HasTraits` instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_trait_values</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="c"># Check for a dynamic initializer.</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">_trait_dyn_inits</span><span class="p">:</span>
                    <span class="n">method</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">_trait_dyn_inits</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">])</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">method</span><span class="p">()</span>
                    <span class="c"># FIXME: Do we really validate here?</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                    <span class="n">obj</span><span class="o">.</span><span class="n">_trait_values</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                    <span class="k">return</span> <span class="n">value</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">TraitError</span><span class="p">(</span><span class="s">&#39;Unexpected error in TraitType: &#39;</span>
                        <span class="s">&#39;both default value and dynamic initializer are &#39;</span>
                        <span class="s">&#39;absent.&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="c"># HasTraits should call set_default_value to populate</span>
                <span class="c"># this.  So this should never be reached.</span>
                <span class="k">raise</span> <span class="n">TraitError</span><span class="p">(</span><span class="s">&#39;Unexpected error in TraitType: &#39;</span>
                                    <span class="s">&#39;default value not set properly&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">__set__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="n">new_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="n">old_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get__</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">_trait_values</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_value</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">silent</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">old_value</span> <span class="o">==</span> <span class="n">new_value</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="c"># if there is an error in comparing, default to notify</span>
            <span class="n">silent</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="n">silent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">True</span><span class="p">:</span>
            <span class="c"># we explicitly compare silent to True just in case the equality</span>
            <span class="c"># comparison above returns something other than True/False</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">_notify_trait</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">old_value</span><span class="p">,</span> <span class="n">new_value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&#39;validate&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&#39;is_valid_for&#39;</span><span class="p">):</span>
            <span class="n">valid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_valid_for</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">valid</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">value</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">TraitError</span><span class="p">(</span><span class="s">&#39;invalid value for type: </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&#39;value_for&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">value_for</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">info_text</span>

    <span class="k">def</span> <span class="nf">error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">e</span> <span class="o">=</span> <span class="s">&quot;The &#39;</span><span class="si">%s</span><span class="s">&#39; trait of </span><span class="si">%s</span><span class="s"> instance must be </span><span class="si">%s</span><span class="s">, but a value of </span><span class="si">%s</span><span class="s"> was specified.&quot;</span> \
                <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">class_of</span><span class="p">(</span><span class="n">obj</span><span class="p">),</span>
                   <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(),</span> <span class="n">repr_type</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">e</span> <span class="o">=</span> <span class="s">&quot;The &#39;</span><span class="si">%s</span><span class="s">&#39; trait must be </span><span class="si">%s</span><span class="s">, but a value of </span><span class="si">%r</span><span class="s"> was specified.&quot;</span> \
                <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(),</span> <span class="n">repr_type</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
        <span class="k">raise</span> <span class="n">TraitError</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&#39;_metadata&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">set_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&#39;_metadata&#39;</span><span class="p">,</span> <span class="p">{})[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>


<span class="c">#-----------------------------------------------------------------------------</span>
<span class="c"># The HasTraits implementation</span>
<span class="c">#-----------------------------------------------------------------------------</span>


<span class="k">class</span> <span class="nc">MetaHasTraits</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A metaclass for HasTraits.</span>

<span class="sd">    This metaclass makes sure that any TraitType class attributes are</span>
<span class="sd">    instantiated and sets their name attribute.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__new__</span><span class="p">(</span><span class="n">mcls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">classdict</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create the HasTraits class.</span>

<span class="sd">        This instantiates all TraitTypes in the class dict and sets their</span>
<span class="sd">        :attr:`name` attribute.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># print &quot;MetaHasTraitlets (mcls, name): &quot;, mcls, name</span>
        <span class="c"># print &quot;MetaHasTraitlets (bases): &quot;, bases</span>
        <span class="c"># print &quot;MetaHasTraitlets (classdict): &quot;, classdict</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">classdict</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">TraitType</span><span class="p">):</span>
                <span class="n">v</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">k</span>
            <span class="k">elif</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isclass</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">TraitType</span><span class="p">):</span>
                    <span class="n">vinst</span> <span class="o">=</span> <span class="n">v</span><span class="p">()</span>
                    <span class="n">vinst</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">k</span>
                    <span class="n">classdict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">vinst</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">MetaHasTraits</span><span class="p">,</span> <span class="n">mcls</span><span class="p">)</span><span class="o">.</span><span class="n">__new__</span><span class="p">(</span><span class="n">mcls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">classdict</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">classdict</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Finish initializing the HasTraits class.</span>

<span class="sd">        This sets the :attr:`this_class` attribute of each TraitType in the</span>
<span class="sd">        class dict to the newly created class ``cls``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">classdict</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">TraitType</span><span class="p">):</span>
                <span class="n">v</span><span class="o">.</span><span class="n">this_class</span> <span class="o">=</span> <span class="n">cls</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">MetaHasTraits</span><span class="p">,</span> <span class="n">cls</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">classdict</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">HasTraits</span><span class="p">(</span><span class="n">py3compat</span><span class="o">.</span><span class="n">with_metaclass</span><span class="p">(</span><span class="n">MetaHasTraits</span><span class="p">,</span> <span class="nb">object</span><span class="p">)):</span>

    <span class="k">def</span> <span class="nf">__new__</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="c"># This is needed because in Python 2.6 object.__new__ only accepts</span>
        <span class="c"># the cls argument.</span>
        <span class="n">new_meth</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">HasTraits</span><span class="p">,</span> <span class="n">cls</span><span class="p">)</span><span class="o">.</span><span class="n">__new__</span>
        <span class="k">if</span> <span class="n">new_meth</span> <span class="ow">is</span> <span class="nb">object</span><span class="o">.</span><span class="n">__new__</span><span class="p">:</span>
            <span class="n">inst</span> <span class="o">=</span> <span class="n">new_meth</span><span class="p">(</span><span class="n">cls</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">inst</span> <span class="o">=</span> <span class="n">new_meth</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
        <span class="n">inst</span><span class="o">.</span><span class="n">_trait_values</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">inst</span><span class="o">.</span><span class="n">_trait_notifiers</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">inst</span><span class="o">.</span><span class="n">_trait_dyn_inits</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c"># Here we tell all the TraitType instances to set their default</span>
        <span class="c"># values on the instance.</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
            <span class="c"># Some descriptors raise AttributeError like zope.interface&#39;s</span>
            <span class="c"># __provides__ attributes even though they exist.  This causes</span>
            <span class="c"># AttributeErrors even though they are listed in dir(cls).</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">TraitType</span><span class="p">):</span>
                    <span class="n">value</span><span class="o">.</span><span class="n">instance_init</span><span class="p">(</span><span class="n">inst</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">inst</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="c"># Allow trait values to be set using keyword arguments.</span>
        <span class="c"># We need to use setattr for this to trigger validation and</span>
        <span class="c"># notifications.</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">kw</span><span class="p">):</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_notify_trait</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">old_value</span><span class="p">,</span> <span class="n">new_value</span><span class="p">):</span>

        <span class="c"># First dynamic ones</span>
        <span class="n">callables</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">callables</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_trait_notifiers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">,[]))</span>
        <span class="n">callables</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_trait_notifiers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;anytrait&#39;</span><span class="p">,[]))</span>

        <span class="c"># Now static ones</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cb</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&#39;_</span><span class="si">%s</span><span class="s">_changed&#39;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">callables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cb</span><span class="p">)</span>

        <span class="c"># Call them all now</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">callables</span><span class="p">:</span>
            <span class="c"># Traits catches and logs errors here.  I allow them to raise</span>
            <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">c</span><span class="p">):</span>
                <span class="n">argspec</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getargspec</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
                <span class="n">nargs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">argspec</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="c"># Bound methods have an additional &#39;self&#39; argument</span>
                <span class="c"># I don&#39;t know how to treat unbound methods, but they</span>
                <span class="c"># can&#39;t really be used for callbacks.</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">MethodType</span><span class="p">):</span>
                    <span class="n">offset</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="n">nargs</span> <span class="o">+</span> <span class="n">offset</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">c</span><span class="p">()</span>
                <span class="k">elif</span> <span class="n">nargs</span> <span class="o">+</span> <span class="n">offset</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">c</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">nargs</span> <span class="o">+</span> <span class="n">offset</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">c</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">new_value</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">nargs</span> <span class="o">+</span> <span class="n">offset</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="n">c</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">old_value</span><span class="p">,</span> <span class="n">new_value</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">TraitError</span><span class="p">(</span><span class="s">&#39;a trait changed callback &#39;</span>
                                        <span class="s">&#39;must have 0-3 arguments.&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">TraitError</span><span class="p">(</span><span class="s">&#39;a trait changed callback &#39;</span>
                                    <span class="s">&#39;must be callable.&#39;</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">_add_notifiers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">handler</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trait_notifiers</span><span class="p">:</span>
            <span class="n">nlist</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_trait_notifiers</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">nlist</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nlist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trait_notifiers</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">handler</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">nlist</span><span class="p">:</span>
            <span class="n">nlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_remove_notifiers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">handler</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trait_notifiers</span><span class="p">:</span>
            <span class="n">nlist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trait_notifiers</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">index</span> <span class="o">=</span> <span class="n">nlist</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">nlist</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">on_trait_change</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">handler</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">remove</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Setup a handler to be called when a trait changes.</span>

<span class="sd">        This is used to setup dynamic notifications of trait changes.</span>

<span class="sd">        Static handlers can be created by creating methods on a HasTraits</span>
<span class="sd">        subclass with the naming convention &#39;_[traitname]_changed&#39;.  Thus,</span>
<span class="sd">        to create static handler for the trait &#39;a&#39;, create the method</span>
<span class="sd">        _a_changed(self, name, old, new) (fewer arguments can be used, see</span>
<span class="sd">        below).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        handler : callable</span>
<span class="sd">            A callable that is called when a trait changes.  Its</span>
<span class="sd">            signature can be handler(), handler(name), handler(name, new)</span>
<span class="sd">            or handler(name, old, new).</span>
<span class="sd">        name : list, str, None</span>
<span class="sd">            If None, the handler will apply to all traits.  If a list</span>
<span class="sd">            of str, handler will apply to all names in the list.  If a</span>
<span class="sd">            str, the handler will apply just to that name.</span>
<span class="sd">        remove : bool</span>
<span class="sd">            If False (the default), then install the handler.  If True</span>
<span class="sd">            then unintall it.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">remove</span><span class="p">:</span>
            <span class="n">names</span> <span class="o">=</span> <span class="n">parse_notifier_name</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_remove_notifiers</span><span class="p">(</span><span class="n">handler</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">names</span> <span class="o">=</span> <span class="n">parse_notifier_name</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_add_notifiers</span><span class="p">(</span><span class="n">handler</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">class_trait_names</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="o">**</span><span class="n">metadata</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get a list of all the names of this class&#39; traits.</span>

<span class="sd">        This method is just like the :meth:`trait_names` method,</span>
<span class="sd">        but is unbound.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">cls</span><span class="o">.</span><span class="n">class_traits</span><span class="p">(</span><span class="o">**</span><span class="n">metadata</span><span class="p">)</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">class_traits</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="o">**</span><span class="n">metadata</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get a `dict` of all the traits of this class.  The dictionary</span>
<span class="sd">        is keyed on the name and the values are the TraitType objects.</span>

<span class="sd">        This method is just like the :meth:`traits` method, but is unbound.</span>

<span class="sd">        The TraitTypes returned don&#39;t know anything about the values</span>
<span class="sd">        that the various HasTrait&#39;s instances are holding.</span>

<span class="sd">        The metadata kwargs allow functions to be passed in which</span>
<span class="sd">        filter traits based on metadata values.  The functions should</span>
<span class="sd">        take a single value as an argument and return a boolean.  If</span>
<span class="sd">        any function returns False, then the trait is not included in</span>
<span class="sd">        the output.  This does not allow for any simple way of</span>
<span class="sd">        testing that a metadata name exists and has any</span>
<span class="sd">        value because get_metadata returns None if a metadata key</span>
<span class="sd">        doesn&#39;t exist.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">traits</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([</span><span class="n">memb</span> <span class="k">for</span> <span class="n">memb</span> <span class="ow">in</span> <span class="n">getmembers</span><span class="p">(</span><span class="n">cls</span><span class="p">)</span> <span class="k">if</span>
                     <span class="nb">isinstance</span><span class="p">(</span><span class="n">memb</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">TraitType</span><span class="p">)])</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">metadata</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">traits</span>

        <span class="k">for</span> <span class="n">meta_name</span><span class="p">,</span> <span class="n">meta_eval</span> <span class="ow">in</span> <span class="n">metadata</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">meta_eval</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">FunctionType</span><span class="p">:</span>
                <span class="n">metadata</span><span class="p">[</span><span class="n">meta_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">_SimpleTest</span><span class="p">(</span><span class="n">meta_eval</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">trait</span> <span class="ow">in</span> <span class="n">traits</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">meta_name</span><span class="p">,</span> <span class="n">meta_eval</span> <span class="ow">in</span> <span class="n">metadata</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">meta_eval</span><span class="p">(</span><span class="n">trait</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="n">meta_name</span><span class="p">)):</span>
                    <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">result</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">trait</span>

        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">trait_names</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">metadata</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get a list of all the names of this class&#39; traits.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">traits</span><span class="p">(</span><span class="o">**</span><span class="n">metadata</span><span class="p">)</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">traits</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">metadata</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get a `dict` of all the traits of this class.  The dictionary</span>
<span class="sd">        is keyed on the name and the values are the TraitType objects.</span>

<span class="sd">        The TraitTypes returned don&#39;t know anything about the values</span>
<span class="sd">        that the various HasTrait&#39;s instances are holding.</span>

<span class="sd">        The metadata kwargs allow functions to be passed in which</span>
<span class="sd">        filter traits based on metadata values.  The functions should</span>
<span class="sd">        take a single value as an argument and return a boolean.  If</span>
<span class="sd">        any function returns False, then the trait is not included in</span>
<span class="sd">        the output.  This does not allow for any simple way of</span>
<span class="sd">        testing that a metadata name exists and has any</span>
<span class="sd">        value because get_metadata returns None if a metadata key</span>
<span class="sd">        doesn&#39;t exist.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">traits</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([</span><span class="n">memb</span> <span class="k">for</span> <span class="n">memb</span> <span class="ow">in</span> <span class="n">getmembers</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="p">)</span> <span class="k">if</span>
                     <span class="nb">isinstance</span><span class="p">(</span><span class="n">memb</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">TraitType</span><span class="p">)])</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">metadata</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">traits</span>

        <span class="k">for</span> <span class="n">meta_name</span><span class="p">,</span> <span class="n">meta_eval</span> <span class="ow">in</span> <span class="n">metadata</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">meta_eval</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">FunctionType</span><span class="p">:</span>
                <span class="n">metadata</span><span class="p">[</span><span class="n">meta_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">_SimpleTest</span><span class="p">(</span><span class="n">meta_eval</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">trait</span> <span class="ow">in</span> <span class="n">traits</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">meta_name</span><span class="p">,</span> <span class="n">meta_eval</span> <span class="ow">in</span> <span class="n">metadata</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">meta_eval</span><span class="p">(</span><span class="n">trait</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="n">meta_name</span><span class="p">)):</span>
                    <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">result</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">trait</span>

        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">trait_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">traitname</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get metadata values for trait by key.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">trait</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="p">,</span> <span class="n">traitname</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">TraitError</span><span class="p">(</span><span class="s">&quot;Class </span><span class="si">%s</span><span class="s"> does not have a trait named </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span>
                                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="n">traitname</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">trait</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

<span class="c">#-----------------------------------------------------------------------------</span>
<span class="c"># Actual TraitTypes implementations/subclasses</span>
<span class="c">#-----------------------------------------------------------------------------</span>

<span class="c">#-----------------------------------------------------------------------------</span>
<span class="c"># TraitTypes subclasses for handling classes and instances of classes</span>
<span class="c">#-----------------------------------------------------------------------------</span>


<span class="k">class</span> <span class="nc">ClassBasedTraitType</span><span class="p">(</span><span class="n">TraitType</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A trait with error reporting for Type, Instance and This.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="n">kind</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">py3compat</span><span class="o">.</span><span class="n">PY3</span><span class="p">)</span> <span class="ow">and</span> <span class="n">kind</span> <span class="ow">is</span> <span class="n">InstanceType</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;class </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">value</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s"> (i.e. </span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="p">(</span> <span class="nb">str</span><span class="p">(</span> <span class="n">kind</span> <span class="p">)[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="nb">repr</span><span class="p">(</span> <span class="n">value</span> <span class="p">)</span> <span class="p">)</span>

        <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">e</span> <span class="o">=</span> <span class="s">&quot;The &#39;</span><span class="si">%s</span><span class="s">&#39; trait of </span><span class="si">%s</span><span class="s"> instance must be </span><span class="si">%s</span><span class="s">, but a value of </span><span class="si">%s</span><span class="s"> was specified.&quot;</span> \
                <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">class_of</span><span class="p">(</span><span class="n">obj</span><span class="p">),</span>
                   <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(),</span> <span class="n">msg</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">e</span> <span class="o">=</span> <span class="s">&quot;The &#39;</span><span class="si">%s</span><span class="s">&#39; trait must be </span><span class="si">%s</span><span class="s">, but a value of </span><span class="si">%r</span><span class="s"> was specified.&quot;</span> \
                <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(),</span> <span class="n">msg</span><span class="p">)</span>

        <span class="k">raise</span> <span class="n">TraitError</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Type</span><span class="p">(</span><span class="n">ClassBasedTraitType</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A trait whose value must be a subclass of a specified class.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">default_value</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">klass</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">allow_none</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="o">**</span><span class="n">metadata</span> <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Construct a Type trait</span>

<span class="sd">        A Type trait specifies that its values must be subclasses of</span>
<span class="sd">        a particular class.</span>

<span class="sd">        If only ``default_value`` is given, it is used for the ``klass`` as</span>
<span class="sd">        well.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        default_value : class, str or None</span>
<span class="sd">            The default value must be a subclass of klass.  If an str,</span>
<span class="sd">            the str must be a fully specified class name, like &#39;foo.bar.Bah&#39;.</span>
<span class="sd">            The string is resolved into real class, when the parent</span>
<span class="sd">            :class:`HasTraits` class is instantiated.</span>
<span class="sd">        klass : class, str, None</span>
<span class="sd">            Values of this trait must be a subclass of klass.  The klass</span>
<span class="sd">            may be specified in a string like: &#39;foo.bar.MyClass&#39;.</span>
<span class="sd">            The string is resolved into real class, when the parent</span>
<span class="sd">            :class:`HasTraits` class is instantiated.</span>
<span class="sd">        allow_none : boolean</span>
<span class="sd">            Indicates whether None is allowed as an assignable value. Even if</span>
<span class="sd">            ``False``, the default value may be ``None``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">default_value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">klass</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">klass</span> <span class="o">=</span> <span class="nb">object</span>
        <span class="k">elif</span> <span class="n">klass</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">klass</span> <span class="o">=</span> <span class="n">default_value</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">isclass</span><span class="p">(</span><span class="n">klass</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">klass</span><span class="p">,</span> <span class="n">py3compat</span><span class="o">.</span><span class="n">string_types</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="n">TraitError</span><span class="p">(</span><span class="s">&quot;A Type trait must specify a class.&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">klass</span>       <span class="o">=</span> <span class="n">klass</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_allow_none</span> <span class="o">=</span> <span class="n">allow_none</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">Type</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">default_value</span><span class="p">,</span> <span class="o">**</span><span class="n">metadata</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Validates that the value is a valid object instance.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">klass</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">value</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_allow_none</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">value</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns a description of the trait.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">klass</span><span class="p">,</span> <span class="n">py3compat</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
            <span class="n">klass</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">klass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">klass</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">klass</span><span class="o">.</span><span class="n">__name__</span>
        <span class="n">result</span> <span class="o">=</span> <span class="s">&#39;a subclass of &#39;</span> <span class="o">+</span> <span class="n">klass</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_allow_none</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">result</span> <span class="o">+</span> <span class="s">&#39; or None&#39;</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">instance_init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_classes</span><span class="p">()</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Type</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">instance_init</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_resolve_classes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">klass</span><span class="p">,</span> <span class="n">py3compat</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">klass</span> <span class="o">=</span> <span class="n">import_item</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">klass</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">default_value</span><span class="p">,</span> <span class="n">py3compat</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="n">import_item</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">default_value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_default_value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_value</span>


<span class="k">class</span> <span class="nc">DefaultValueGenerator</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A class for generating new default value instances.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="n">args</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kw</span> <span class="o">=</span> <span class="n">kw</span>

    <span class="k">def</span> <span class="nf">generate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">klass</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">klass</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">kw</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Instance</span><span class="p">(</span><span class="n">ClassBasedTraitType</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A trait whose value must be an instance of a specified class.</span>

<span class="sd">    The value can also be an instance of a subclass of the specified class.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">klass</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">kw</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">allow_none</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="o">**</span><span class="n">metadata</span> <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Construct an Instance trait.</span>

<span class="sd">        This trait allows values that are instances of a particular</span>
<span class="sd">        class or its sublclasses.  Our implementation is quite different</span>
<span class="sd">        from that of enthough.traits as we don&#39;t allow instances to be used</span>
<span class="sd">        for klass and we handle the ``args`` and ``kw`` arguments differently.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        klass : class, str</span>
<span class="sd">            The class that forms the basis for the trait.  Class names</span>
<span class="sd">            can also be specified as strings, like &#39;foo.bar.Bar&#39;.</span>
<span class="sd">        args : tuple</span>
<span class="sd">            Positional arguments for generating the default value.</span>
<span class="sd">        kw : dict</span>
<span class="sd">            Keyword arguments for generating the default value.</span>
<span class="sd">        allow_none : bool</span>
<span class="sd">            Indicates whether None is allowed as a value.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        If both ``args`` and ``kw`` are None, then the default value is None.</span>
<span class="sd">        If ``args`` is a tuple and ``kw`` is a dict, then the default is</span>
<span class="sd">        created as ``klass(*args, **kw)``.  If either ``args`` or ``kw`` is</span>
<span class="sd">        not (but not both), None is replace by ``()`` or ``{}``.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_allow_none</span> <span class="o">=</span> <span class="n">allow_none</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">klass</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">isclass</span><span class="p">(</span><span class="n">klass</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">klass</span><span class="p">,</span> <span class="n">py3compat</span><span class="o">.</span><span class="n">string_types</span><span class="p">))):</span>
            <span class="k">raise</span> <span class="n">TraitError</span><span class="p">(</span><span class="s">&#39;The klass argument must be a class&#39;</span>
                                <span class="s">&#39; you gave: </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">klass</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">klass</span> <span class="o">=</span> <span class="n">klass</span>

        <span class="c"># self.klass is a class, so handle default_value</span>
        <span class="k">if</span> <span class="n">args</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">kw</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">default_value</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">args</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="c"># kw is not None</span>
                <span class="n">args</span> <span class="o">=</span> <span class="p">()</span>
            <span class="k">elif</span> <span class="n">kw</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="c"># args is not None</span>
                <span class="n">kw</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">kw</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">TraitError</span><span class="p">(</span><span class="s">&quot;The &#39;kw&#39; argument must be a dict or None.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">TraitError</span><span class="p">(</span><span class="s">&quot;The &#39;args&#39; argument must be a tuple or None.&quot;</span><span class="p">)</span>

            <span class="n">default_value</span> <span class="o">=</span> <span class="n">DefaultValueGenerator</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">Instance</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">default_value</span><span class="p">,</span> <span class="o">**</span><span class="n">metadata</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_allow_none</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">value</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">klass</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">value</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">klass</span><span class="p">,</span> <span class="n">py3compat</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
            <span class="n">klass</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">klass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">klass</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">klass</span><span class="o">.</span><span class="n">__name__</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">class_of</span><span class="p">(</span><span class="n">klass</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_allow_none</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">result</span> <span class="o">+</span> <span class="s">&#39; or None&#39;</span>

        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">instance_init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_classes</span><span class="p">()</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Instance</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">instance_init</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_resolve_classes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">klass</span><span class="p">,</span> <span class="n">py3compat</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">klass</span> <span class="o">=</span> <span class="n">import_item</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">klass</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_default_value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Instantiate a default value instance.</span>

<span class="sd">        This is called when the containing HasTraits classes&#39;</span>
<span class="sd">        :meth:`__new__` method is called to ensure that a unique instance</span>
<span class="sd">        is created for each HasTraits instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dv</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_value</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dv</span><span class="p">,</span> <span class="n">DefaultValueGenerator</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">dv</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">klass</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">dv</span>


<span class="k">class</span> <span class="nc">This</span><span class="p">(</span><span class="n">ClassBasedTraitType</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A trait for instances of the class containing this trait.</span>

<span class="sd">    Because how how and when class bodies are executed, the ``This``</span>
<span class="sd">    trait can only have a default value of None.  This, and because we</span>
<span class="sd">    always validate default values, ``allow_none`` is *always* true.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">info_text</span> <span class="o">=</span> <span class="s">&#39;an instance of the same type as the receiver or None&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">metadata</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">This</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">metadata</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="c"># What if value is a superclass of obj.__class__?  This is</span>
        <span class="c"># complicated if it was the superclass that defined the This</span>
        <span class="c"># trait.</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">this_class</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">value</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>


<span class="c">#-----------------------------------------------------------------------------</span>
<span class="c"># Basic TraitTypes implementations/subclasses</span>
<span class="c">#-----------------------------------------------------------------------------</span>


<span class="k">class</span> <span class="nc">Any</span><span class="p">(</span><span class="n">TraitType</span><span class="p">):</span>
    <span class="n">default_value</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">info_text</span> <span class="o">=</span> <span class="s">&#39;any value&#39;</span>


<span class="k">class</span> <span class="nc">Int</span><span class="p">(</span><span class="n">TraitType</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;An int trait.&quot;&quot;&quot;</span>

    <span class="n">default_value</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">info_text</span> <span class="o">=</span> <span class="s">&#39;an int&#39;</span>

    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">CInt</span><span class="p">(</span><span class="n">Int</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A casting version of the int trait.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

<span class="k">if</span> <span class="n">py3compat</span><span class="o">.</span><span class="n">PY3</span><span class="p">:</span>
    <span class="n">Long</span><span class="p">,</span> <span class="n">CLong</span> <span class="o">=</span> <span class="n">Int</span><span class="p">,</span> <span class="n">CInt</span>
    <span class="n">Integer</span> <span class="o">=</span> <span class="n">Int</span>
<span class="k">else</span><span class="p">:</span>
    <span class="k">class</span> <span class="nc">Long</span><span class="p">(</span><span class="n">TraitType</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;A long integer trait.&quot;&quot;&quot;</span>

        <span class="n">default_value</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">info_text</span> <span class="o">=</span> <span class="s">&#39;a long&#39;</span>

        <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">long</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">value</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                <span class="k">return</span> <span class="nb">long</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>


    <span class="k">class</span> <span class="nc">CLong</span><span class="p">(</span><span class="n">Long</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;A casting version of the long integer trait.&quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">long</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Integer</span><span class="p">(</span><span class="n">TraitType</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;An integer trait.</span>

<span class="sd">        Longs that are unnecessary (&lt;= sys.maxint) are cast to ints.&quot;&quot;&quot;</span>

        <span class="n">default_value</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">info_text</span> <span class="o">=</span> <span class="s">&#39;an integer&#39;</span>

        <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">value</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">long</span><span class="p">):</span>
                <span class="c"># downcast longs that fit in int:</span>
                <span class="c"># note that int(n &gt; sys.maxint) returns a long, so</span>
                <span class="c"># we don&#39;t need a condition on this cast</span>
                <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s">&quot;cli&quot;</span><span class="p">:</span>
                <span class="kn">from</span> <span class="nn">System</span> <span class="kn">import</span> <span class="n">Int64</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Int64</span><span class="p">):</span>
                    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Float</span><span class="p">(</span><span class="n">TraitType</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A float trait.&quot;&quot;&quot;</span>

    <span class="n">default_value</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">info_text</span> <span class="o">=</span> <span class="s">&#39;a float&#39;</span>

    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">value</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">CFloat</span><span class="p">(</span><span class="n">Float</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A casting version of the float trait.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Complex</span><span class="p">(</span><span class="n">TraitType</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A trait for complex numbers.&quot;&quot;&quot;</span>

    <span class="n">default_value</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="o">+</span> <span class="mf">0.0j</span>
    <span class="n">info_text</span> <span class="o">=</span> <span class="s">&#39;a complex number&#39;</span>

    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">complex</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">value</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">)):</span>
            <span class="k">return</span> <span class="nb">complex</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">CComplex</span><span class="p">(</span><span class="n">Complex</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A casting version of the complex number trait.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">validate</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">complex</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

<span class="c"># We should always be explicit about whether we&#39;re using bytes or unicode, both</span>
<span class="c"># for Python 3 conversion and for reliable unicode behaviour on Python 2. So</span>
<span class="c"># we don&#39;t have a Str type.</span>
<span class="k">class</span> <span class="nc">Bytes</span><span class="p">(</span><span class="n">TraitType</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A trait for byte strings.&quot;&quot;&quot;</span>

    <span class="n">default_value</span> <span class="o">=</span> <span class="n">b</span><span class="s">&#39;&#39;</span>
    <span class="n">info_text</span> <span class="o">=</span> <span class="s">&#39;a bytes object&#39;</span>

    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">CBytes</span><span class="p">(</span><span class="n">Bytes</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A casting version of the byte string trait.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Unicode</span><span class="p">(</span><span class="n">TraitType</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A trait for unicode strings.&quot;&quot;&quot;</span>

    <span class="n">default_value</span> <span class="o">=</span> <span class="s">u&#39;&#39;</span>
    <span class="n">info_text</span> <span class="o">=</span> <span class="s">&#39;a unicode string&#39;</span>

    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">py3compat</span><span class="o">.</span><span class="n">unicode_type</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">value</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">value</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&#39;ascii&#39;</span><span class="p">,</span> <span class="s">&#39;strict&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">UnicodeDecodeError</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;Could not decode {!r} for unicode trait &#39;{}&#39; of {} instance.&quot;</span>
                <span class="k">raise</span> <span class="n">TraitError</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">class_of</span><span class="p">(</span><span class="n">obj</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">CUnicode</span><span class="p">(</span><span class="n">Unicode</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A casting version of the unicode trait.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">py3compat</span><span class="o">.</span><span class="n">unicode_type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">ObjectName</span><span class="p">(</span><span class="n">TraitType</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A string holding a valid object name in this version of Python.</span>

<span class="sd">    This does not check that the name exists in any scope.&quot;&quot;&quot;</span>
    <span class="n">info_text</span> <span class="o">=</span> <span class="s">&quot;a valid object identifier in Python&quot;</span>

    <span class="k">if</span> <span class="n">py3compat</span><span class="o">.</span><span class="n">PY3</span><span class="p">:</span>
        <span class="c"># Python 3:</span>
        <span class="n">coerce_str</span> <span class="o">=</span> <span class="nb">staticmethod</span><span class="p">(</span><span class="k">lambda</span> <span class="n">_</span><span class="p">,</span><span class="n">s</span><span class="p">:</span> <span class="n">s</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="c"># Python 2:</span>
        <span class="k">def</span> <span class="nf">coerce_str</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
            <span class="s">&quot;In Python 2, coerce ascii-only unicode to str&quot;</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">unicode</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">UnicodeEncodeError</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coerce_str</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">py3compat</span><span class="o">.</span><span class="n">isidentifier</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">DottedObjectName</span><span class="p">(</span><span class="n">ObjectName</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A string holding a valid dotted object name in Python, such as A.b3._c&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coerce_str</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">py3compat</span><span class="o">.</span><span class="n">isidentifier</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">dotted</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Bool</span><span class="p">(</span><span class="n">TraitType</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A boolean (True, False) trait.&quot;&quot;&quot;</span>

    <span class="n">default_value</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">info_text</span> <span class="o">=</span> <span class="s">&#39;a boolean&#39;</span>

    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">CBool</span><span class="p">(</span><span class="n">Bool</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A casting version of the boolean trait.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Enum</span><span class="p">(</span><span class="n">TraitType</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;An enum that whose value must be in a given sequence.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">default_value</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">allow_none</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="o">**</span><span class="n">metadata</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="n">values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_allow_none</span> <span class="o">=</span> <span class="n">allow_none</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Enum</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">default_value</span><span class="p">,</span> <span class="o">**</span><span class="n">metadata</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_allow_none</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">value</span>

        <span class="k">if</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns a description of the trait.&quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="s">&#39;any of &#39;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_allow_none</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">result</span> <span class="o">+</span> <span class="s">&#39; or None&#39;</span>
        <span class="k">return</span> <span class="n">result</span>

<span class="k">class</span> <span class="nc">CaselessStrEnum</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;An enum of strings that are caseless in validate.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_allow_none</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">value</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">py3compat</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">value</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="k">return</span> <span class="n">v</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Container</span><span class="p">(</span><span class="n">Instance</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;An instance of a container (list, set, etc.)</span>

<span class="sd">    To be subclassed by overriding klass.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">klass</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">_cast_types</span> <span class="o">=</span> <span class="p">()</span>
    <span class="n">_valid_defaults</span> <span class="o">=</span> <span class="n">SequenceTypes</span>
    <span class="n">_trait</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trait</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">default_value</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">allow_none</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                <span class="o">**</span><span class="n">metadata</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a container trait type from a list, set, or tuple.</span>

<span class="sd">        The default value is created by doing ``List(default_value)``,</span>
<span class="sd">        which creates a copy of the ``default_value``.</span>

<span class="sd">        ``trait`` can be specified, which restricts the type of elements</span>
<span class="sd">        in the container to that TraitType.</span>

<span class="sd">        If only one arg is given and it is not a Trait, it is taken as</span>
<span class="sd">        ``default_value``:</span>

<span class="sd">        ``c = List([1,2,3])``</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        trait : TraitType [ optional ]</span>
<span class="sd">            the type for restricting the contents of the Container.  If unspecified,</span>
<span class="sd">            types are not checked.</span>

<span class="sd">        default_value : SequenceType [ optional ]</span>
<span class="sd">            The default value for the Trait.  Must be list/tuple/set, and</span>
<span class="sd">            will be cast to the container type.</span>

<span class="sd">        allow_none : Bool [ default True ]</span>
<span class="sd">            Whether to allow the value to be None</span>

<span class="sd">        **metadata : any</span>
<span class="sd">            further keys for extensions to the Trait (e.g. config)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># allow List([values]):</span>
        <span class="k">if</span> <span class="n">default_value</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_trait</span><span class="p">(</span><span class="n">trait</span><span class="p">):</span>
            <span class="n">default_value</span> <span class="o">=</span> <span class="n">trait</span>
            <span class="n">trait</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="k">if</span> <span class="n">default_value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">=</span> <span class="p">()</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">default_value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_valid_defaults</span><span class="p">):</span>
            <span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="n">default_value</span><span class="p">,)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&#39;default value of </span><span class="si">%s</span><span class="s"> was </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="n">default_value</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">is_trait</span><span class="p">(</span><span class="n">trait</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_trait</span> <span class="o">=</span> <span class="n">trait</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">trait</span><span class="p">,</span> <span class="nb">type</span><span class="p">)</span> <span class="k">else</span> <span class="n">trait</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_trait</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&#39;element&#39;</span>
        <span class="k">elif</span> <span class="n">trait</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&quot;`trait` must be a Trait or None, got </span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="n">repr_type</span><span class="p">(</span><span class="n">trait</span><span class="p">))</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">Container</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">klass</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">klass</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">,</span>
                                  <span class="n">allow_none</span><span class="o">=</span><span class="n">allow_none</span><span class="p">,</span> <span class="o">**</span><span class="n">metadata</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">element_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">element</span><span class="p">,</span> <span class="n">validator</span><span class="p">):</span>
        <span class="n">e</span> <span class="o">=</span> <span class="s">&quot;Element of the &#39;</span><span class="si">%s</span><span class="s">&#39; trait of </span><span class="si">%s</span><span class="s"> instance must be </span><span class="si">%s</span><span class="s">, but a value of </span><span class="si">%s</span><span class="s"> was specified.&quot;</span> \
            <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">class_of</span><span class="p">(</span><span class="n">obj</span><span class="p">),</span> <span class="n">validator</span><span class="o">.</span><span class="n">info</span><span class="p">(),</span> <span class="n">repr_type</span><span class="p">(</span><span class="n">element</span><span class="p">))</span>
        <span class="k">raise</span> <span class="n">TraitError</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cast_types</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">klass</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">Container</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">value</span>

        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate_elements</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">validate_elements</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="n">validated</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trait</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_trait</span><span class="p">,</span> <span class="n">Any</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">value</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trait</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">TraitError</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">element_error</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trait</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">validated</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">klass</span><span class="p">(</span><span class="n">validated</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">List</span><span class="p">(</span><span class="n">Container</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;An instance of a Python list.&quot;&quot;&quot;</span>
    <span class="n">klass</span> <span class="o">=</span> <span class="nb">list</span>
    <span class="n">_cast_types</span> <span class="o">=</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trait</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">default_value</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">minlen</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">maxlen</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">maxsize</span><span class="p">,</span>
                <span class="n">allow_none</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="o">**</span><span class="n">metadata</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a List trait type from a list, set, or tuple.</span>

<span class="sd">        The default value is created by doing ``List(default_value)``,</span>
<span class="sd">        which creates a copy of the ``default_value``.</span>

<span class="sd">        ``trait`` can be specified, which restricts the type of elements</span>
<span class="sd">        in the container to that TraitType.</span>

<span class="sd">        If only one arg is given and it is not a Trait, it is taken as</span>
<span class="sd">        ``default_value``:</span>

<span class="sd">        ``c = List([1,2,3])``</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        trait : TraitType [ optional ]</span>
<span class="sd">            the type for restricting the contents of the Container.  If unspecified,</span>
<span class="sd">            types are not checked.</span>

<span class="sd">        default_value : SequenceType [ optional ]</span>
<span class="sd">            The default value for the Trait.  Must be list/tuple/set, and</span>
<span class="sd">            will be cast to the container type.</span>

<span class="sd">        minlen : Int [ default 0 ]</span>
<span class="sd">            The minimum length of the input list</span>

<span class="sd">        maxlen : Int [ default sys.maxsize ]</span>
<span class="sd">            The maximum length of the input list</span>

<span class="sd">        allow_none : Bool [ default True ]</span>
<span class="sd">            Whether to allow the value to be None</span>

<span class="sd">        **metadata : any</span>
<span class="sd">            further keys for extensions to the Trait (e.g. config)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_minlen</span> <span class="o">=</span> <span class="n">minlen</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_maxlen</span> <span class="o">=</span> <span class="n">maxlen</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">List</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">trait</span><span class="o">=</span><span class="n">trait</span><span class="p">,</span> <span class="n">default_value</span><span class="o">=</span><span class="n">default_value</span><span class="p">,</span>
                                <span class="n">allow_none</span><span class="o">=</span><span class="n">allow_none</span><span class="p">,</span> <span class="o">**</span><span class="n">metadata</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">length_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="n">e</span> <span class="o">=</span> <span class="s">&quot;The &#39;</span><span class="si">%s</span><span class="s">&#39; trait of </span><span class="si">%s</span><span class="s"> instance must be of length </span><span class="si">%i</span><span class="s"> &lt;= L &lt;= </span><span class="si">%i</span><span class="s">, but a value of </span><span class="si">%s</span><span class="s"> was specified.&quot;</span> \
            <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">class_of</span><span class="p">(</span><span class="n">obj</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_minlen</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_maxlen</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">TraitError</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">validate_elements</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="n">length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">length</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_minlen</span> <span class="ow">or</span> <span class="n">length</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_maxlen</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">length_error</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">List</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">validate_elements</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">List</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">value</span>

        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate_elements</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">value</span>
        


<span class="k">class</span> <span class="nc">Set</span><span class="p">(</span><span class="n">List</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;An instance of a Python set.&quot;&quot;&quot;</span>
    <span class="n">klass</span> <span class="o">=</span> <span class="nb">set</span>
    <span class="n">_cast_types</span> <span class="o">=</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Tuple</span><span class="p">(</span><span class="n">Container</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;An instance of a Python tuple.&quot;&quot;&quot;</span>
    <span class="n">klass</span> <span class="o">=</span> <span class="nb">tuple</span>
    <span class="n">_cast_types</span> <span class="o">=</span> <span class="p">(</span><span class="nb">list</span><span class="p">,)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">traits</span><span class="p">,</span> <span class="o">**</span><span class="n">metadata</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Tuple(*traits, default_value=None, allow_none=True, **medatata)</span>

<span class="sd">        Create a tuple from a list, set, or tuple.</span>

<span class="sd">        Create a fixed-type tuple with Traits:</span>

<span class="sd">        ``t = Tuple(Int, Str, CStr)``</span>

<span class="sd">        would be length 3, with Int,Str,CStr for each element.</span>

<span class="sd">        If only one arg is given and it is not a Trait, it is taken as</span>
<span class="sd">        default_value:</span>

<span class="sd">        ``t = Tuple((1,2,3))``</span>

<span class="sd">        Otherwise, ``default_value`` *must* be specified by keyword.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        *traits : TraitTypes [ optional ]</span>
<span class="sd">            the tsype for restricting the contents of the Tuple.  If unspecified,</span>
<span class="sd">            types are not checked. If specified, then each positional argument</span>
<span class="sd">            corresponds to an element of the tuple.  Tuples defined with traits</span>
<span class="sd">            are of fixed length.</span>

<span class="sd">        default_value : SequenceType [ optional ]</span>
<span class="sd">            The default value for the Tuple.  Must be list/tuple/set, and</span>
<span class="sd">            will be cast to a tuple. If `traits` are specified, the</span>
<span class="sd">            `default_value` must conform to the shape and type they specify.</span>

<span class="sd">        allow_none : Bool [ default True ]</span>
<span class="sd">            Whether to allow the value to be None</span>

<span class="sd">        **metadata : any</span>
<span class="sd">            further keys for extensions to the Trait (e.g. config)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">default_value</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;default_value&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="n">allow_none</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;allow_none&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>

        <span class="c"># allow Tuple((values,)):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">traits</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">default_value</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_trait</span><span class="p">(</span><span class="n">traits</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">default_value</span> <span class="o">=</span> <span class="n">traits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">traits</span> <span class="o">=</span> <span class="p">()</span>

        <span class="k">if</span> <span class="n">default_value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">=</span> <span class="p">()</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">default_value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_valid_defaults</span><span class="p">):</span>
            <span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="n">default_value</span><span class="p">,)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&#39;default value of </span><span class="si">%s</span><span class="s"> was </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="n">default_value</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_traits</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">trait</span> <span class="ow">in</span> <span class="n">traits</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">trait</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">trait</span><span class="p">,</span> <span class="nb">type</span><span class="p">)</span> <span class="k">else</span> <span class="n">trait</span>
            <span class="n">t</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&#39;element&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_traits</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_traits</span> <span class="ow">and</span> <span class="n">default_value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="c"># don&#39;t allow default to be an empty container if length is specified</span>
            <span class="n">args</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Container</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">klass</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">klass</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">,</span>
                                  <span class="n">allow_none</span><span class="o">=</span><span class="n">allow_none</span><span class="p">,</span> <span class="o">**</span><span class="n">metadata</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">validate_elements</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_traits</span><span class="p">:</span>
            <span class="c"># nothing to validate</span>
            <span class="k">return</span> <span class="n">value</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_traits</span><span class="p">):</span>
            <span class="n">e</span> <span class="o">=</span> <span class="s">&quot;The &#39;</span><span class="si">%s</span><span class="s">&#39; trait of </span><span class="si">%s</span><span class="s"> instance requires </span><span class="si">%i</span><span class="s"> elements, but a value of </span><span class="si">%s</span><span class="s"> was specified.&quot;</span> \
                <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">class_of</span><span class="p">(</span><span class="n">obj</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_traits</span><span class="p">),</span> <span class="n">repr_type</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
            <span class="k">raise</span> <span class="n">TraitError</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

        <span class="n">validated</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">t</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_traits</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">v</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">TraitError</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">element_error</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">validated</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">validated</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Dict</span><span class="p">(</span><span class="n">Instance</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;An instance of a Python dict.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">default_value</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">allow_none</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="o">**</span><span class="n">metadata</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a dict trait type from a dict.</span>

<span class="sd">        The default value is created by doing ``dict(default_value)``,</span>
<span class="sd">        which creates a copy of the ``default_value``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">default_value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">=</span> <span class="p">((),)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">default_value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="n">default_value</span><span class="p">,)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">default_value</span><span class="p">,</span> <span class="n">SequenceTypes</span><span class="p">):</span>
            <span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="n">default_value</span><span class="p">,)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&#39;default value of Dict was </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">default_value</span><span class="p">)</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">Dict</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">klass</span><span class="o">=</span><span class="nb">dict</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">,</span>
                                  <span class="n">allow_none</span><span class="o">=</span><span class="n">allow_none</span><span class="p">,</span> <span class="o">**</span><span class="n">metadata</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">TCPAddress</span><span class="p">(</span><span class="n">TraitType</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A trait for an (ip, port) tuple.</span>

<span class="sd">    This allows for both IPv4 IP addresses as well as hostnames.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">default_value</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;127.0.0.1&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">info_text</span> <span class="o">=</span> <span class="s">&#39;an (ip, port) tuple&#39;</span>

    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">py3compat</span><span class="o">.</span><span class="n">string_types</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">int</span><span class="p">):</span>
                    <span class="n">port</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">port</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">port</span> <span class="o">&lt;=</span> <span class="mi">65535</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">CRegExp</span><span class="p">(</span><span class="n">TraitType</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A casting compiled regular expression trait.</span>

<span class="sd">    Accepts both strings and compiled regular expressions. The resulting</span>
<span class="sd">    attribute will be a compiled regular expression.&quot;&quot;&quot;</span>

    <span class="n">info_text</span> <span class="o">=</span> <span class="s">&#39;a regular expression&#39;</span>

    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">OpenAlea community website</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &copy; Copyright 2014, INRIA VirtualPlants.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.3.1.
    </div>
  </body>
</html>